#!/usr/bin/env bash

[[ $DEBUG = true ]] && set -x

TEST_DIR=${DIAGNOSTICS_TEST_DIR:-$PWD}
export TEST_RUN_ID="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

# shellcheck source=/dev/null
source $TEST_DIR/env

main() {
  if [ $# -gt 1 ] && [ -f "$TEST_DIR/$1" ]; then
    basht "$TEST_DIR/$1"
  else
    test_all
  fi
}

run_core_tests() {
  echo "--- :: core"
  basht $TEST_DIR/*_test.bash
}
run_other_tests() {
  local failed
  for dir in $TEST_DIR/*/
  do
      dir=${dir%*/}
      group=${dir##*/}
      echo
      echo "--- :: ${group}"
      basht $dir/*_test.bash
      [[ $? == 0 ]] || failed=1
  done
}
test_all() {
  local failed

  run_core_tests
  [[ $? == 0 ]] || failed=1

  run_other_tests
  [[ $? == 0 ]] || failed=1

  exit $failed
}

main "$@"
